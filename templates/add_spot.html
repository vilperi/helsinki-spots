{% extends "layout.html" %}

{% block title %}Lisää kohde{% endblock %}

{% block extra_head %}
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
{% endblock %}

{% block content %}
<form action="/create_spot" method="post" enctype="multipart/form-data">
  <p>
    <label for="name">Kohteen nimi:</label> <br />
    <input type="text" id="name" name="name" maxlength="50" size="25" value="{{ name or '' }}" required />
  </p>
  <p>
    <label for="image">Kuvat:<br>(Maksimikoko <strong>500 kt</strong>, hyväksytty tiedostomuoto <strong>.png</strong>)</label><br>
    <input
      type="file"
      id ="image"
      name="image"
      accept=".png"
      value="{{ files or '' }}"
      class="{% if errors.files %}error{% endif %}"
      multiple
    />
    {% if errors.files %}
      <span class="notice">{{ errors.files }}</span>
    {% endif %}
  </p>
  <p>
    <label for="coords">Koordinaatit: Klikkaa kartalta ja liitä kopioidut koordinaatit kenttään</label><br />
    <div id="form-map"></div>
    <br>
    <input
      type="text"
      id="coords"
      name="coords"
      pattern="^\d{2}\.\d{5}, \d{2}\.\d{5}$"
      maxlength="18"
      value="{{ coords or '' }}"
      class="{% if errors.lat %}error{% endif %}"
      required/> &lt-- Liitä koordinaatit tähän
    {% if errors.coords %}
      <span class="notice">{{ errors.coords }}</span>
    {% endif %}
  </p>
  <p>
    <label for="description">Kuvaus:</label> <br />
    <textarea id="description" name="description" rows="8" cols="60" maxlength="1000" value="{{ description or '' }}"></textarea>
  </p>
  <label for="category">Kategoria:</label>
  <select id="category" name="category" required>
    <option value="" disabled selected hidden>Valitse kategoria</option>
    {% for cat in categories %}
      <option value="{{ cat }}" {% if cat == category %}selected{% endif %}>{{ cat }}</option>
    {% endfor %}
  </select>
  <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
  <input type="submit" name="cancel" value="Peruuta" formnovalidate/>
  <input type="submit" name="add" value="Lisää kohde" />
</form>
{% endblock %}

{% block extra_scripts %}
<script>
  var map = L.map ('form-map', {
    maxBounds: [
      [59.9, 24.6],
      [60.4, 25.3]
    ]
  }).setView([60.1699, 24.9384], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      noWrap: true,
      attribution: '&copy; OpenStreetMap'
    }).addTo(window.map);

  // Copy lat/lon to clipboard on click
  map.on('click', function (e) {
    const lat = e.latlng.lat.toFixed(5);
    const lon = e.latlng.lng.toFixed(5);
    const text = `${lat}, ${lon}`;

    navigator.clipboard.writeText(text)
        .then(() => {
            console.log("Copied:", text);
            // Optional: toast popup or temporary alert
            L.popup()
                .setLatLng(e.latlng)
                .setContent(`Copied to clipboard:<br>${text}`)
                .openOn(map);
        })
        .catch(err => {
            console.error("Clipboard copy failed", err);
        });
});
</script>
{% endblock %}